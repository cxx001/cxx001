<!DOCTYPE HTML>
<html lang="zh-CN">

<head>
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="Hexo">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.0.0">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="https://cxx001.gitee.io">
    <!--SEO-->

<meta name="keywords" content="1553b" />


<meta name="description" content="
TODO：这段比较忙，先快速记录个大概，后面得空再详细整理下，尽量表述得通俗易懂~

简介1553b板卡主要应用于航天航空工业领域，它的数据传输结构有点类似集中分布式服务器的设计，分为BC、R..." />


<meta name="robots" content="all" />
<meta name="google" content="all" />
<meta name="googlebot" content="all" />
<meta name="verify" content="all" />
    <!--Title-->

<title>
    
    1553B板卡详解 |
    
    Hexo
</title>

<link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">


<link rel="icon" href="/favicon.ico">

    


<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7.css">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.7.0.css">
<link rel="stylesheet" href="/css/style.css?rev=@@hash.css">

    
<div class="hide">
    <script type="text/javascript">
    var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
    document.write(unescape("%3Cspan class='cnzz_stat_icon_1263868967 hide' %3E%3Cscript%20src%3D%22https%3A%2F%2Fs95.cnzz.com%2Fz_stat.php%3Fweb_id%3D1272564536%22%3E%3C%2Fscript%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s19.cnzz.com/z_stat.php%3Fid%3D1263868967%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
    </script>
</div>




    

<meta name="generator" content="Hexo 6.2.0"></head>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->
<body>
    <header class="main-header"  style="background-image:url(
    https://hexo-theme-snippet-1251680922.cos.ap-beijing.myqcloud.com/img/banner.jpg)"
     >
    <div class="main-header-box">
        <a class="header-avatar" href="/" title='John Doe'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a>
        <div class="branding">
            <!--<h2 class="text-hide">Snippet主题,从未如此简单有趣</h2>-->
            
            <img src="/img/branding.png" alt="Snippet 博客主题" class="img-responsive center-block">
            
        </div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                        <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="https://cxx001.gitee.io">
                        Hexo</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                        <li role="presentation" class="text-center">
                            <a href="/"><i class="fa "></i>
                                首页</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/archives/"><i class="fa "></i>
                                时间轴</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/guestbook/"><i class="fa "></i>
                                留言</a>
                        </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="1553B板卡详解">
            
            1553B板卡详解
            
        </h1>
        <div class="post-meta">
    
    <span class="categories-meta fa-wrap">
        <i class="fa fa-folder-open-o"></i>
        <a class="category-link" href="/categories/project/">project</a>
    </span>
    
    
    <span class="fa-wrap">
        <i class="fa fa-tags"></i>
        <span class="tags-meta">
            
            <a class="tag-none-link" href="/tags/1553b/" rel="tag">1553b</a>
            
        </span>
    </span>
    
    
    
    <span class="fa-wrap">
        <i class="fa fa-clock-o"></i>
        <span class="date-meta">
            2023/11/06</span>
    </span>
    
    <span class="fa-wrap">
        <i class="fa fa-eye"></i>
        <span id="busuanzi_value_page_pv"></span>
    </span>
    
    
</div>
        
        
    </div>
    
    <div class="post-body post-content">
        <blockquote>
<p>TODO：这段比较忙，先快速记录个大概，后面得空再详细整理下，尽量表述得通俗易懂~</p>
</blockquote>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>1553b板卡主要应用于航天航空工业领域，它的数据传输结构有点类似集中分布式服务器的设计，分为BC、RT、BM三类部件，BC有且仅有1个，类似我们的master管理服务节点，RT有0~32个，类似我们的各业务服务节点，BM则是监控节点。所以按传统服务器设计结构也很好理解1553B了。</p>
<h1 id="环境安装"><a href="#环境安装" class="headerlink" title="环境安装"></a>环境安装</h1><ol>
<li><p>安装驱动，驱动盘里有个imsk的脚本执行一下就好了，需要注意的是驱动版本一定要与板卡一致。</p>
</li>
<li><p>接线，各通道的线通过耦合器连到一起就可以了。</p>
<p><img src="https://cxx001.gitee.io/2023/11/06/project/1553B%E6%9D%BF%E5%8D%A1%E8%AF%A6%E8%A7%A3/image-20231103113338486.png"></p>
</li>
</ol>
<h1 id="模拟工具"><a href="#模拟工具" class="headerlink" title="模拟工具"></a>模拟工具</h1><p>在windows上提供了一个测试工具，<code>FlightPack-1553B</code>可以与自己封装的1553B模块对测。</p>
<p><img src="https://cxx001.gitee.io/2023/11/06/project/1553B%E6%9D%BF%E5%8D%A1%E8%AF%A6%E8%A7%A3/image-20231106091027549.png"></p>
<p>BC设置，我一般用的子帧模式，添加需要的消息，主要是BC有些设置，其它基本没什么要设置的，像RT基本就是使能下就可以了。</p>
<p><img src="https://cxx001.gitee.io/2023/11/06/project/1553B%E6%9D%BF%E5%8D%A1%E8%AF%A6%E8%A7%A3/image-20231106092823183.png"></p>
<h1 id="模块封装"><a href="#模块封装" class="headerlink" title="模块封装"></a>模块封装</h1><p>RT封装倒是比较简单，直接参考示例程序就行了，没什么特别的，主要是BC的封装，有几个点需要注意，它是一个管理类，消息个数是可以动态添加的，而且默认子帧模式，消息有开始和结束形成一个环。还一点特别注意在设置RT-&gt;RT消息时，消息块的<code>cmd_wd1</code>字段只能是接收，<code>cmd_wd2</code>只能是发送。</p>
<h2 id="1-RT"><a href="#1-RT" class="headerlink" title="1. RT"></a>1. RT</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;CtrlSysLibTool.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Port_1553B_RT.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WIN32</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;json.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kl_common_info.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">CAV1553B_RT_INFO</span> &#123;</span><br><span class="line">    <span class="built_in">CAV1553B_RT_INFO</span>(CORE_U16 dev_num, CORE_U32 channel_num, CORE_U16 rt_addr, CORE_U16 sub_addr)</span><br><span class="line">        : <span class="built_in">dev_num_</span>(dev_num), <span class="built_in">channel_num_</span>(channel_num), <span class="built_in">rt_addr_</span>(rt_addr), <span class="built_in">sub_addr_</span>(sub_addr)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;rt_sabuf_, <span class="number">0</span>, <span class="built_in">sizeof</span>(rt_sabuf_));</span><br><span class="line">        rt_sabuf_.legal_wc = <span class="number">0xFFFFFFFF</span>;</span><br><span class="line">        data_size_ = <span class="built_in">sizeof</span>(rt_sabuf_.data_wds);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CORE_RT_SA_BUFFER rt_sabuf_; <span class="comment">// rt读写buffer</span></span><br><span class="line">    <span class="type">int</span> data_size_;              <span class="comment">// data_wds数据的长度，这里会默认32个CORE_U16（unsigned short）</span></span><br><span class="line">    CORE_U16 dev_num_;           <span class="comment">// 设备号</span></span><br><span class="line">    CORE_U32 channel_num_;       <span class="comment">// 通道号</span></span><br><span class="line">    CORE_U16 rt_addr_;           <span class="comment">// RT 地址，取值范围 0~31；</span></span><br><span class="line">    CORE_U16 sub_addr_;          <span class="comment">// RT 子地址，取值范围 0~31；</span></span><br><span class="line">    std::map&lt;std::pair&lt;CORE_U16, CORE_U32&gt;, <span class="type">bool</span>&gt;</span><br><span class="line">            *init_info_1553b_;     <span class="comment">// 记录通道初始化情况，相同的dev_num及channel_num只初始化一次</span></span><br><span class="line">    std::vector&lt;std::string&gt; vars; <span class="comment">// 存储协议字段的类型</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***********************************</span></span><br><span class="line"><span class="comment">        内部变量初始化</span></span><br><span class="line"><span class="comment">        内部变量：rtinfo_</span></span><br><span class="line"><span class="comment">***********************************/</span></span><br><span class="line"><span class="function"><span class="type">int32_t</span> <span class="title">Block_Port_1553B_RT::initInternalVariable</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;CAV1553BInit start...\n&quot;</span>);</span><br><span class="line">    <span class="comment">// Devnum 由设备编号和 1553 板卡类型组成。其中：</span></span><br><span class="line">    <span class="comment">// 1）设备编号：设备编号（从 0 开始编号），取值范围 0~3。</span></span><br><span class="line">    <span class="comment">// 2）1553 板卡类型：</span></span><br><span class="line">    <span class="comment">// devnum = (0 | PCI_1553_TYPE)，代表的是 PCI1553 板卡，设备 0；</span></span><br><span class="line">    <span class="comment">// devnum = (1 | PCI_1553_TYPE)，代表的是 PCI1553 板卡，设备 1；</span></span><br><span class="line">    <span class="comment">// devnum = (0 | USB_1553_TYPE)，代表的是 USB1553 板卡，设备 0；</span></span><br><span class="line">    <span class="comment">// devnum = (1 | USB_1553_TYPE)，代表的是 USB1553 板卡，设备 1。</span></span><br><span class="line">    CORE_U16 dev_num = (CORE_U16)<span class="built_in">P</span>(devNum) | PCI_1553_TYPE;</span><br><span class="line">    CORE_U32 channel_num = <span class="built_in">P</span>(channelNum);</span><br><span class="line">    CORE_U16 rt_addr = <span class="built_in">P</span>(rtAddr);</span><br><span class="line">    CORE_U16 sub_addr = <span class="built_in">P</span>(subAddr);</span><br><span class="line"></span><br><span class="line">    rtinfo_ = <span class="keyword">new</span> <span class="built_in">CAV1553B_RT_INFO</span>(dev_num, channel_num, rt_addr, sub_addr);</span><br><span class="line">    CAV1553B_RT_INFO *rtinfo = <span class="built_in">static_cast</span>&lt;CAV1553B_RT_INFO *&gt;(rtinfo_);</span><br><span class="line">    rtinfo-&gt;init_info_1553b_ = <span class="built_in">GetInitInfo_1553b</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> iter = rtinfo-&gt;init_info_1553b_-&gt;<span class="built_in">find</span>(&#123; dev_num, channel_num &#125;);</span><br><span class="line">    <span class="comment">// 没有找到，或者找到了但是为false，则表示未初始化，那么进行相关初始化操作</span></span><br><span class="line">    <span class="keyword">if</span> (iter == rtinfo-&gt;init_info_1553b_-&gt;<span class="built_in">end</span>()) &#123;</span><br><span class="line">        <span class="comment">// 该函数用于初始化某一个板卡的通道。三个参数分别为：设备号、通道号、中断队列长度（取值：4,8,16,32,64,128,256。）</span></span><br><span class="line">        <span class="comment">// SUCCESS：设备初始化成功；FAILURE：设备初始化失败。</span></span><br><span class="line">        <span class="keyword">if</span> (FAILURE == <span class="built_in">CORE_GEN_Full_Init</span>(dev_num, channel_num, <span class="number">16</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">LOG_INFO</span>(<span class="string">&quot;CORE_GEN_Full_Init finished...\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// CORE_RT_Multiple_Is_Supported 用于查看板卡是否支持多 RT 功能。</span></span><br><span class="line">        <span class="comment">// 1：支持多 RT；0：不支持多 RT。</span></span><br><span class="line">        <span class="type">int</span> multiple = <span class="built_in">CORE_RT_Multiple_Is_Supported</span>(dev_num, channel_num);</span><br><span class="line">        <span class="keyword">if</span> (!multiple &amp;&amp; rt_addr &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;not support multiple,channel_num = %d\n&quot;</span>, (<span class="type">int</span>)channel_num);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">LOG_INFO</span>(<span class="string">&quot;CORE_RT_Multiple_Is_Supported finished...\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// CORE_RT_Init 用于初始化板卡中的 RT 功能，进行 RT 内存分配，在用 RT 功能之前，需要调用此函数。</span></span><br><span class="line">        <span class="comment">// SUCCESS：RT 初始化成功；FAILURE：RT 初始化失败。</span></span><br><span class="line">        <span class="keyword">if</span> (FAILURE == <span class="built_in">CORE_RT_Init</span>(dev_num, channel_num)) &#123;</span><br><span class="line">            <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;Initializing RT Failure,channel_num = %d\n&quot;</span>, (<span class="type">int</span>)channel_num);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">		</span><br><span class="line">		rtinfo-&gt;init_info_1553b_-&gt;<span class="built_in">insert</span>(&#123; &#123; dev_num, channel_num &#125;, <span class="literal">true</span> &#125;);</span><br><span class="line">		</span><br><span class="line">        <span class="built_in">LOG_INFO</span>(<span class="string">&quot;CORE_RT_Init finished...\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// CORE_RT_Enable 用来使能某一特定的 RT 地址，使其有效。使用任何 RT 之前都需要使能这个 RT 地址，否则 RT</span></span><br><span class="line">    <span class="comment">// 将不工作。</span></span><br><span class="line">    <span class="built_in">CORE_RT_Enable</span>(dev_num, channel_num, rt_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// CORE_RT_Allocate_SA_Buffers 为特定的 RT 的子地址分配一个或者多个缓冲区，用于存储相关数据</span></span><br><span class="line">    <span class="comment">// SUCCESS：RT 缓冲分配成功；FAILURE：RT 缓冲分配失败。</span></span><br><span class="line">    <span class="comment">// devnum：见上面注释；</span></span><br><span class="line">    <span class="comment">// channel_num：通道编号（从 0 开始编号），取值范围 0~3；</span></span><br><span class="line">    <span class="comment">// rt：RT 地址，取值范围 0~31；</span></span><br><span class="line">    <span class="comment">// tr：发送还是接收。 1：发送；0：接收；</span></span><br><span class="line">    <span class="comment">// sa：RT 子地址，取值范围 0~31；</span></span><br><span class="line">    <span class="comment">// num_bufs：要分配多少个缓冲 buffer。</span></span><br><span class="line">    CORE_U16 tr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">P</span>(bsend)) &#123;</span><br><span class="line">        tr = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (FAILURE == <span class="built_in">CORE_RT_Allocate_SA_Buffers</span>(dev_num, channel_num, rt_addr, tr, sub_addr, <span class="number">1</span>)) &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;Allocating Failure,channel_num = %d\n&quot;</span>, (<span class="type">int</span>)channel_num);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;CORE_RT_Allocate_SA_Buffers finished...\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (FAILURE == <span class="built_in">CORE_RT_Write_SA_Buffer</span>(dev_num, channel_num, rt_addr, tr, sub_addr, <span class="number">0</span>, &amp;rtinfo-&gt;rt_sabuf_)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// CORE_RT_Start运行已经配置好的 RT 。</span></span><br><span class="line">    <span class="built_in">CORE_RT_Start</span>(dev_num, channel_num);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*****************************解析协议json文件, 将协议字段的类型放入数组中***********************/</span></span><br><span class="line">    nlohmann::ordered_json root;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _WIN32</span></span><br><span class="line">    std::ifstream(<span class="built_in">P</span>(filename).<span class="built_in">c_str</span>()) &gt;&gt; root;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    std::string strfilePath = <span class="built_in">P</span>(filename).<span class="built_in">c_str</span>();</span><br><span class="line">    std::string strfile = <span class="string">&quot;protocol/&quot;</span> + strfilePath.<span class="built_in">substr</span>(strfilePath.<span class="built_in">find_last_of</span>(<span class="string">&quot;/&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">access</span>(strfile.<span class="built_in">c_str</span>(), F_OK) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    std::ifstream(strfile.<span class="built_in">c_str</span>()) &gt;&gt; root;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    nlohmann::ordered_json child = root[<span class="string">&quot;Protocol fields&quot;</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;item : child.<span class="built_in">items</span>()) &#123;</span><br><span class="line">        rtinfo-&gt;vars.<span class="built_in">push_back</span>(item.<span class="built_in">value</span>()[<span class="string">&quot;type&quot;</span>]);</span><br><span class="line">        <span class="comment">// std::string tp = item.value()[&quot;type&quot;];</span></span><br><span class="line">        <span class="comment">// LOG_ERROR(&quot;type=%s\n&quot;, tp.c_str());</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> bi = <span class="built_in">P</span>(bsend) &amp;&amp; <span class="built_in">I</span>(p_dynamic_Input_).size_ != rtinfo-&gt;vars.<span class="built_in">size</span>();</span><br><span class="line">    <span class="type">bool</span> bo = !<span class="built_in">P</span>(bsend) &amp;&amp; <span class="built_in">O</span>(p_dynamic_Output_).size_ != rtinfo-&gt;vars.<span class="built_in">size</span>();</span><br><span class="line">    <span class="keyword">if</span> (bi || bo) &#123;</span><br><span class="line">        <span class="comment">// 如果动态输入端口的个数与协议字段的个数不一致则有错误</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    binit_ = <span class="literal">true</span>; <span class="comment">// 标识已完成初始化</span></span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;CAV1553BInit  success...\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**********************************</span></span><br><span class="line"><span class="comment">        在此函数中编写自定义代码</span></span><br><span class="line"><span class="comment">        输入变量：</span></span><br><span class="line"><span class="comment">        输出变量：</span></span><br><span class="line"><span class="comment">        参数：bsend, channelNum, devNum, filename, rtAddr, subAddr</span></span><br><span class="line"><span class="comment">        状态变量：</span></span><br><span class="line"><span class="comment">        示例：O(输出变量) = I(输入变量) + P(参数)</span></span><br><span class="line"><span class="comment">***********************************/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Block_Port_1553B_RT::runAlgorithm</span><span class="params">(<span class="type">void</span> *extra)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    CAV1553B_RT_INFO *rtinfo = <span class="built_in">static_cast</span>&lt;CAV1553B_RT_INFO *&gt;(rtinfo_);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//memset(&amp;rtinfo-&gt;rt_sabuf_, 0, sizeof(rtinfo-&gt;rt_sabuf_)); // 清空上次数据</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">P</span>(bsend)) &#123;</span><br><span class="line">        <span class="comment">// 作为发送模块</span></span><br><span class="line">        <span class="type">size_t</span> offset = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; rtinfo-&gt;vars.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">1</span> == <span class="built_in">P</span>(checkType) &amp;&amp; i == rtinfo-&gt;vars.<span class="built_in">size</span>() - <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// checkType==1时为crc校验</span></span><br><span class="line">                <span class="type">uint16_t</span> crc = <span class="built_in">get_crc16</span>((<span class="type">uint8_t</span> *)rtinfo-&gt;rt_sabuf_.data_wds, offset);</span><br><span class="line">                <span class="built_in">memcpy</span>(rtinfo-&gt;rt_sabuf_.data_wds + offset, &amp;crc, <span class="built_in">sizeof</span>(<span class="type">uint16_t</span>));</span><br><span class="line">                offset += <span class="built_in">sizeof</span>(<span class="type">uint16_t</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">size_t</span> var_len = <span class="built_in">type_len</span>(rtinfo-&gt;vars[i]);</span><br><span class="line">            <span class="built_in">convert_var_to_buffer</span>(rtinfo-&gt;vars[i], offset, (<span class="type">uint8_t</span> *)rtinfo-&gt;rt_sabuf_.data_wds,</span><br><span class="line">                                  <span class="built_in">I</span>(p_dynamic_Input_).ptr_[i], var_len);</span><br><span class="line">            offset += var_len;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 不能超过缓存大小</span></span><br><span class="line">        <span class="keyword">if</span> (offset &lt;= rtinfo-&gt;data_size_) &#123;</span><br><span class="line">            <span class="keyword">if</span> (SUCCESS</span><br><span class="line">                == <span class="built_in">CORE_RT_Write_SA_Buffer</span>(rtinfo-&gt;dev_num_, rtinfo-&gt;channel_num_, rtinfo-&gt;rt_addr_, <span class="number">1</span>,</span><br><span class="line">                                           rtinfo-&gt;sub_addr_, <span class="number">0</span>, &amp;rtinfo-&gt;rt_sabuf_)) &#123; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 作为接收模块</span></span><br><span class="line">        <span class="keyword">if</span> (SUCCESS</span><br><span class="line">            == <span class="built_in">CORE_RT_Read_SA_Buffer</span>(rtinfo-&gt;dev_num_, rtinfo-&gt;channel_num_, rtinfo-&gt;rt_addr_, <span class="number">0</span>, rtinfo-&gt;sub_addr_, <span class="number">0</span>,</span><br><span class="line">                                      &amp;rtinfo-&gt;rt_sabuf_)) &#123;</span><br><span class="line">            <span class="type">size_t</span> offset = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; rtinfo-&gt;vars.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="number">1</span> == <span class="built_in">P</span>(checkType) &amp;&amp; i == rtinfo-&gt;vars.<span class="built_in">size</span>() - <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="comment">// checkType==1时为crc校验</span></span><br><span class="line">                    <span class="type">uint16_t</span> crc = <span class="built_in">get_crc16</span>((<span class="type">uint8_t</span> *)rtinfo-&gt;rt_sabuf_.data_wds, offset); <span class="comment">// 先计算自己的crc</span></span><br><span class="line">                    <span class="type">uint16_t</span> *recv_crc = (<span class="type">uint16_t</span> *)(rtinfo-&gt;rt_sabuf_.data_wds + offset); <span class="comment">// 解析收到数据包的crc字段</span></span><br><span class="line">                    <span class="keyword">if</span> (crc != *recv_crc) &#123;</span><br><span class="line">                        <span class="comment">// 错误信息</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    offset += <span class="built_in">sizeof</span>(<span class="type">uint16_t</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">size_t</span> var_len = <span class="built_in">type_len</span>(rtinfo-&gt;vars[i]);</span><br><span class="line">                *<span class="built_in">O</span>(p_dynamic_Output_).ptr_[i] =</span><br><span class="line">                        <span class="built_in">convert_buffer_to_var</span>(rtinfo-&gt;vars[i], offset, (<span class="type">uint8_t</span> *)rtinfo-&gt;rt_sabuf_.data_wds);</span><br><span class="line">                offset += var_len;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**********************************</span></span><br><span class="line"><span class="comment">在此函数中编写自定义积分函数</span></span><br><span class="line"><span class="comment">***********************************/</span></span><br><span class="line"><span class="function"><span class="type">int32_t</span> <span class="title">Block_Port_1553B_RT::integral</span><span class="params">(<span class="type">int32_t</span> msg, <span class="type">double</span> t, <span class="type">double</span> *state, <span class="type">double</span> *derivative)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**********************************</span></span><br><span class="line"><span class="comment">        在此函数中释放内部变量资源</span></span><br><span class="line"><span class="comment">        内部变量：rtinfo_</span></span><br><span class="line"><span class="comment">***********************************/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Block_Port_1553B_RT::destroyInternalVariable</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 是否调用了初始化函数，默认为false（控制引擎会出现直接调用destroy的情况，而成员变量si_未初始化被使用会导致崩溃）</span></span><br><span class="line">    <span class="keyword">if</span> (!binit_) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    CAV1553B_RT_INFO *rtinfo = <span class="built_in">static_cast</span>&lt;CAV1553B_RT_INFO *&gt;(rtinfo_);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CORE_RT_Disable</span>(rtinfo-&gt;dev_num_, rtinfo-&gt;channel_num_, rtinfo-&gt;rt_addr_);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> iter = rtinfo-&gt;init_info_1553b_-&gt;<span class="built_in">find</span>(&#123; rtinfo-&gt;dev_num_, rtinfo-&gt;channel_num_ &#125;);</span><br><span class="line">    <span class="keyword">if</span> (iter == rtinfo-&gt;init_info_1553b_-&gt;<span class="built_in">end</span>() || !iter-&gt;second) &#123;</span><br><span class="line">        <span class="built_in">CORE_RT_Stop</span>(rtinfo-&gt;dev_num_, rtinfo-&gt;channel_num_);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span> rtinfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2-BC"><a href="#2-BC" class="headerlink" title="2. BC"></a>2. BC</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;CtrlSysLibTool.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Port_1553B_BC.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WIN32</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;json.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kl_common_info.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">CAV1553B_BC_INFO</span> &#123;</span><br><span class="line">    <span class="built_in">CAV1553B_BC_INFO</span>(CORE_U16 dev_num, CORE_U32 channel_num, doubleVector&amp; rt_addr, doubleVector&amp; sub_addr, doubleVector&amp; msg_type)</span><br><span class="line">        : <span class="built_in">dev_num_</span>(dev_num)</span><br><span class="line">        , <span class="built_in">channel_num_</span>(channel_num)</span><br><span class="line">        , <span class="built_in">init_info_1553b_</span>(<span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;bc_sabuf_, <span class="number">0</span>, <span class="built_in">sizeof</span>(bc_sabuf_));</span><br><span class="line">        data_size_ = <span class="built_in">sizeof</span>(bc_sabuf_.data_wds);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">32</span>; i++) &#123;</span><br><span class="line">            rt_addr_[i] = (CORE_U16)rt_addr[i];</span><br><span class="line">            sub_addr_[i] = (CORE_U16)sub_addr[i];</span><br><span class="line">            msg_type_[i] = (CORE_U16)msg_type[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CORE_BC_MSG_BUFFER bc_sabuf_; <span class="comment">// bc读写buffer</span></span><br><span class="line">    <span class="type">int</span> data_size_; <span class="comment">// data_wds数据的长度，这里会默认32个CORE_U16（unsigned short）</span></span><br><span class="line">    CORE_U16 dev_num_; <span class="comment">// 设备号</span></span><br><span class="line">    CORE_U32 channel_num_; <span class="comment">// 通道号</span></span><br><span class="line">    CORE_U16 rt_addr_[<span class="number">32</span>]; <span class="comment">// RT 地址，取值范围 0~31；</span></span><br><span class="line">    CORE_U16 sub_addr_[<span class="number">32</span>]; <span class="comment">// RT 子地址，取值范围 0~31；</span></span><br><span class="line">    CORE_U16 msg_type_[<span class="number">32</span>]; <span class="comment">// BC消息类型，如rt-&gt;bc,bc-&gt;rt,rt-&gt;rt</span></span><br><span class="line">    std::map&lt;std::pair&lt;CORE_U16, CORE_U32&gt;, <span class="type">bool</span>&gt;* init_info_1553b_; <span class="comment">// 记录通道初始化情况，相同的dev_num及channel_num只初始化一次</span></span><br><span class="line">    std::vector&lt;std::vector&lt;std::string&gt;&gt; bc_rt_vars; <span class="comment">// 存储bc-&gt;rt协议字段的类型</span></span><br><span class="line">    std::vector&lt;std::vector&lt;std::string&gt;&gt; rt_bc_vars; <span class="comment">// 存储rt-&gt;bc协议字段的类型</span></span><br><span class="line">    std::vector&lt;<span class="type">int</span>&gt; bc_rt_nums; <span class="comment">// bc-&gt;rt消息个数</span></span><br><span class="line">    std::vector&lt;<span class="type">int</span>&gt; rt_bc_nums; <span class="comment">// rt-&gt;bc消息个数</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***********************************</span></span><br><span class="line"><span class="comment">        内部变量初始化</span></span><br><span class="line"><span class="comment">        内部变量：bcinfo_</span></span><br><span class="line"><span class="comment">***********************************/</span></span><br><span class="line"><span class="function"><span class="type">int32_t</span> <span class="title">Block_Port_1553B_BC::initInternalVariable</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;CAV1553B_BC_Init start...\n&quot;</span>);</span><br><span class="line">    <span class="comment">// Devnum 由设备编号和 1553 板卡类型组成。其中：</span></span><br><span class="line">    <span class="comment">// 1）设备编号：设备编号（从 0 开始编号），取值范围 0~3。</span></span><br><span class="line">    <span class="comment">// 2）1553 板卡类型：</span></span><br><span class="line">    <span class="comment">// devnum = (0 | PCI_1553_TYPE)，代表的是 PCI1553 板卡，设备 0；</span></span><br><span class="line">    <span class="comment">// devnum = (1 | PCI_1553_TYPE)，代表的是 PCI1553 板卡，设备 1；</span></span><br><span class="line">    <span class="comment">// devnum = (0 | USB_1553_TYPE)，代表的是 USB1553 板卡，设备 0；</span></span><br><span class="line">    <span class="comment">// devnum = (1 | USB_1553_TYPE)，代表的是 USB1553 板卡，设备 1。</span></span><br><span class="line">    CORE_U16 dev_num = (CORE_U16)<span class="built_in">P</span>(devNum) | PCI_1553_TYPE;</span><br><span class="line">    CORE_U32 channel_num = (CORE_U32)<span class="built_in">P</span>(channelNum);</span><br><span class="line"></span><br><span class="line">    bcinfo_ = <span class="keyword">new</span> <span class="built_in">CAV1553B_BC_INFO</span>(dev_num, channel_num, <span class="built_in">P</span>(rtAddr), <span class="built_in">P</span>(subAddr), <span class="built_in">P</span>(msgType));</span><br><span class="line">    CAV1553B_BC_INFO* bcinfo = <span class="built_in">static_cast</span>&lt;CAV1553B_BC_INFO*&gt;(bcinfo_);</span><br><span class="line">    bcinfo-&gt;init_info_1553b_ = <span class="built_in">GetInitInfo_1553b</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> block_count = <span class="built_in">P</span>(msgType).<span class="built_in">size</span>();</span><br><span class="line">    <span class="keyword">auto</span> iter = bcinfo-&gt;init_info_1553b_-&gt;<span class="built_in">find</span>(&#123; dev_num, channel_num &#125;);</span><br><span class="line">    <span class="comment">// 没有找到，或者找到了但是为false，则表示未初始化，那么进行相关初始化操作</span></span><br><span class="line">    <span class="keyword">if</span> (iter == bcinfo-&gt;init_info_1553b_-&gt;<span class="built_in">end</span>() || !iter-&gt;second) &#123;</span><br><span class="line">        <span class="comment">// 该函数用于初始化某一个板卡的通道。三个参数分别为：设备号、通道号、中断队列长度（取值：4,8,16,32,64,128,256。）</span></span><br><span class="line">        <span class="comment">// SUCCESS：设备初始化成功；FAILURE：设备初始化失败。</span></span><br><span class="line">        <span class="keyword">if</span> (FAILURE == <span class="built_in">CORE_GEN_Full_Init</span>(dev_num, channel_num, <span class="number">16</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">LOG_INFO</span>(<span class="string">&quot;CORE_GEN_Full_Init finished...\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        CORE_BC_Is_Supported 查看板卡是否支持 BC 功能。</span></span><br><span class="line"><span class="comment">        1：支持 BC；</span></span><br><span class="line"><span class="comment">        0：不支持 BC</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="type">int</span> surportBC = <span class="built_in">CORE_BC_Is_Supported</span>(dev_num, channel_num);</span><br><span class="line">        <span class="keyword">if</span> (!surportBC) &#123;</span><br><span class="line">            <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;not support BC,channel_num = %d\n&quot;</span>, (<span class="type">int</span>)channel_num);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">LOG_INFO</span>(<span class="string">&quot;CORE_BC_Is_Supported finished...\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            CORE_BC_Init 用于初始化板卡中的 BC 功能，设置 BC 需要发送的消息个数</span></span><br><span class="line"><span class="comment">            devnum：设备号；</span></span><br><span class="line"><span class="comment">            channel_num：通道编号（从 0 开始编号），取值范围 0~3；</span></span><br><span class="line"><span class="comment">            num_blocks：所需建立的 BC BLOCK 的个数；</span></span><br><span class="line"><span class="comment">            frame_us：以 us 为单位的子帧时间间隔，取值范围 40~0xFFFFFFFF；</span></span><br><span class="line"><span class="comment">            wTimeout1：无响应时间，单位 us，取值范围 0~31。当 wTimeout1 和 wTimeout2都为 0</span></span><br><span class="line"><span class="comment">           时为不设置延时时间，使用系统默认时间）； wTimeout2：最迟响应时间，单位 us，取值范围 0~31。（当 wTimeout1 和</span></span><br><span class="line"><span class="comment">           wTimeout2都为 0 时为不设置延时时间，使用系统默认时间）</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">CORE_BC_Init</span>(dev_num, channel_num, block_count, <span class="number">100000</span>, <span class="number">0</span>, <span class="number">0</span>) == FAILURE) &#123;</span><br><span class="line">            <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;Initializing BC Failure,channel_num = %d\n&quot;</span>, (<span class="type">int</span>)channel_num);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">LOG_INFO</span>(<span class="string">&quot;CORE_BC_Init finished...\n&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;BC is Initializing\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CORE_BC_BLOCK bc_block;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; block_count; i++) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        CORE_BC_Allocate_Msg_Buffers 为特定的 BC Block 分配 Message Buffers。</span></span><br><span class="line"><span class="comment">        devnum：设备号；</span></span><br><span class="line"><span class="comment">        channel_num：通道编号（从 0 开始编号），取值范围 0~3；</span></span><br><span class="line"><span class="comment">        msg_num：BC Block 编号（需要为哪个 BLOCK 分配消息）；</span></span><br><span class="line"><span class="comment">        num_buffs：所需分配的消息的个数，默认值为 1。</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">CORE_BC_Allocate_Msg_Buffers</span>(dev_num, channel_num, i, <span class="number">1</span>) == FAILURE) &#123;</span><br><span class="line">            <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;CORE_BC_Allocate_Msg_Buffers  Failure,channel_num = %d\n&quot;</span>, (<span class="type">int</span>)channel_num);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>(&amp;bc_block, <span class="number">0</span>, <span class="built_in">sizeof</span>(bc_block));</span><br><span class="line">        <span class="type">int</span> bcMsgType = (<span class="type">int</span>)<span class="built_in">P</span>(msgType)[i];</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> == i) &#123;</span><br><span class="line">            bc_block.next_msg_num = i + <span class="number">1</span>;</span><br><span class="line">            bc_block.bc_control_wd = bcMsgType | BC_BLOCK_FRAME_BEGIN | BC_BLOCK_FLAG_BUS_A;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (block_count - <span class="number">1</span> == i) &#123;</span><br><span class="line">            bc_block.next_msg_num = <span class="number">0</span>;</span><br><span class="line">            bc_block.bc_control_wd = bcMsgType | BC_BLOCK_FRAME_END | BC_BLOCK_FLAG_BUS_A;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            bc_block.next_msg_num = i + <span class="number">1</span>;</span><br><span class="line">            bc_block.bc_control_wd = bcMsgType | BC_BLOCK_FLAG_BUS_A;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            CORE_Set_BC_Command 组合 MIL-STD-1553B BC 的命令字。</span></span><br><span class="line"><span class="comment">            devnum：设备号</span></span><br><span class="line"><span class="comment">            channel_num：通道编号（从 0 开始编号），取值范围 0~3；</span></span><br><span class="line"><span class="comment">            RT：RT 地址，取值范围 0~31；</span></span><br><span class="line"><span class="comment">            tr：发送还是接收。1 代表发送，0 代表接收；</span></span><br><span class="line"><span class="comment">            data_count：数据字个数，取值范围：0~31（0 代表 32 个字）；</span></span><br><span class="line"><span class="comment">            如果消息是 ModeCode 类型，data_count 代表的是模式代码。</span></span><br><span class="line"><span class="comment">            subaddr：RT 子地址，取值范围 0~31</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">		<span class="keyword">if</span> (bcMsgType == BC_BLOCK_TYPE_MSG_RTRT) &#123;</span><br><span class="line">			<span class="comment">// 当消息类型为RT-&gt;RT时，接收的RT必须设置到cmd_wd1中，发送的RT设置到cmd_wd2中</span></span><br><span class="line">			<span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">P</span>(rtType)[i]) &#123;</span><br><span class="line">				bc_block.cmd_wd1 = <span class="built_in">CORE_Set_BC_Command</span>(dev_num, channel_num, <span class="built_in">P</span>(rtAddr)[i], <span class="built_in">P</span>(rtType)[i], <span class="number">0</span>, <span class="built_in">P</span>(subAddr)[i]);</span><br><span class="line">				bc_block.cmd_wd2 = <span class="built_in">CORE_Set_BC_Command</span>(dev_num, channel_num, <span class="built_in">P</span>(rtAddr)[i + <span class="number">1</span>], <span class="built_in">P</span>(rtType)[i + <span class="number">1</span>], <span class="number">0</span>, <span class="built_in">P</span>(subAddr)[i + <span class="number">1</span>]);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				bc_block.cmd_wd1 = <span class="built_in">CORE_Set_BC_Command</span>(dev_num, channel_num, <span class="built_in">P</span>(rtAddr)[i + <span class="number">1</span>], <span class="built_in">P</span>(rtType)[i + <span class="number">1</span>], <span class="number">0</span>, <span class="built_in">P</span>(subAddr)[i + <span class="number">1</span>]);</span><br><span class="line">				bc_block.cmd_wd2 = <span class="built_in">CORE_Set_BC_Command</span>(dev_num, channel_num, <span class="built_in">P</span>(rtAddr)[i], <span class="built_in">P</span>(rtType)[i], <span class="number">0</span>, <span class="built_in">P</span>(subAddr)[i]);</span><br><span class="line">			&#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            bc_block.cmd_wd1 = <span class="built_in">CORE_Set_BC_Command</span>(dev_num, channel_num, <span class="built_in">P</span>(rtAddr)[i], <span class="built_in">P</span>(rtType)[i], <span class="number">0</span>, <span class="built_in">P</span>(subAddr)[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        bc_block.im_gap = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            CORE_BC_Write_Block 函数将用户设置好的 BC BLOCK，通过向 API 函数传入结构体的方式写到板卡内存中。</span></span><br><span class="line"><span class="comment">            devnum：设备号；</span></span><br><span class="line"><span class="comment">            channel_num：通道编号（从 0 开始编号），取值范围 0~3；</span></span><br><span class="line"><span class="comment">            msg_num：BC BLOCK 编号（需要为哪个 BLOCK 分配消息）；</span></span><br><span class="line"><span class="comment">            bc_block：需设置的 BC BLOCK 结构体</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">CORE_BC_Write_Block</span>(dev_num, channel_num, i, &amp;bc_block) == FAILURE) &#123;</span><br><span class="line">            <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;CORE_BC_Write_Block  Failure,channel_num = %d\n&quot;</span>, (<span class="type">int</span>)channel_num);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bcMsgType == BC_BLOCK_TYPE_MSG_BCRT) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                CORE_BC_Write_Buffer 函数将用户设置好的 BC BLOCK 对应的消息，通过向API 函数传入结构体的方式写到板卡内存中</span></span><br><span class="line"><span class="comment">                devnum：设备号</span></span><br><span class="line"><span class="comment">                channel_num：通道编号（从 0 开始编号），取值范围 0~3；</span></span><br><span class="line"><span class="comment">                msg_num：BC BLOCK 编号（需要为哪个 BLOCK 分配消息）；  // 指定分配的通道</span></span><br><span class="line"><span class="comment">                buffnum：BC BLOCK 对应的消息编号；</span></span><br><span class="line"><span class="comment">                msg_buff：需设置的 CORE_BC_MSG_BUFFER 结构体的指针。</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">CORE_BC_Write_Buffer</span>(dev_num, channel_num, i, <span class="number">0</span>, &amp;bcinfo-&gt;bc_sabuf_) == FAILURE) &#123; <span class="comment">// 这里自定义一个编号吧</span></span><br><span class="line">                <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;CORE_BC_Write_Buffer  Failure,channel_num = %d\n&quot;</span>, (<span class="type">int</span>)channel_num);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            bcinfo-&gt;bc_rt_nums.<span class="built_in">push_back</span>(i);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bcMsgType == BC_BLOCK_TYPE_MSG_RTBC) &#123;</span><br><span class="line">            bcinfo-&gt;rt_bc_nums.<span class="built_in">push_back</span>(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// CORE_BC_Start 运行已经配置好的 BC</span></span><br><span class="line">    <span class="built_in">CORE_BC_Start</span>(dev_num, channel_num, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*****************************解析协议json文件, 将协议字段的类型放入数组中***********************/</span></span><br><span class="line">    nlohmann::ordered_json root;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _WIN32</span></span><br><span class="line">    std::ifstream(<span class="built_in">P</span>(filename).<span class="built_in">c_str</span>()) &gt;&gt; root;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    std::string strfilePath = <span class="built_in">P</span>(filename).<span class="built_in">c_str</span>();</span><br><span class="line">    std::string strfile = <span class="string">&quot;protocol/&quot;</span> + strfilePath.<span class="built_in">substr</span>(strfilePath.<span class="built_in">find_last_of</span>(<span class="string">&quot;/&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">access</span>(strfile.<span class="built_in">c_str</span>(), F_OK) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    std::ifstream(strfile.<span class="built_in">c_str</span>()) &gt;&gt; root;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; field : root[<span class="string">&quot;Protocol fields&quot;</span>][<span class="string">&quot;bc_rt&quot;</span>]) &#123;</span><br><span class="line">        std::vector&lt;std::string&gt; innerVector;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; subfield : field) &#123;</span><br><span class="line">            innerVector.<span class="built_in">push_back</span>(subfield[<span class="string">&quot;type&quot;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (innerVector.<span class="built_in">size</span>() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            bcinfo-&gt;bc_rt_vars.<span class="built_in">push_back</span>(innerVector);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; field : root[<span class="string">&quot;Protocol fields&quot;</span>][<span class="string">&quot;rt_bc&quot;</span>]) &#123;</span><br><span class="line">        std::vector&lt;std::string&gt; innerVector;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; subfield : field) &#123;</span><br><span class="line">            innerVector.<span class="built_in">push_back</span>(subfield[<span class="string">&quot;type&quot;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        bcinfo-&gt;rt_bc_vars.<span class="built_in">push_back</span>(innerVector);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    binit_ = <span class="literal">true</span>; <span class="comment">// 标识已完成初始化</span></span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;CAV1553B_BC_Init  success...\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**********************************</span></span><br><span class="line"><span class="comment">        在此函数中编写自定义代码</span></span><br><span class="line"><span class="comment">        输入变量：</span></span><br><span class="line"><span class="comment">        输出变量：</span></span><br><span class="line"><span class="comment">        参数：bsend, channelNum, devNum, filename, rtAddr, subAddr</span></span><br><span class="line"><span class="comment">        状态变量：</span></span><br><span class="line"><span class="comment">        示例：O(输出变量) = I(输入变量) + P(参数)</span></span><br><span class="line"><span class="comment">***********************************/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Block_Port_1553B_BC::runAlgorithm</span><span class="params">(<span class="type">void</span>* extra)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    CAV1553B_BC_INFO* bcinfo = <span class="built_in">static_cast</span>&lt;CAV1553B_BC_INFO*&gt;(bcinfo_);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// BC-&gt;RT</span></span><br><span class="line">    <span class="type">size_t</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; bcinfo-&gt;bc_rt_nums.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        <span class="type">size_t</span> offset = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> j = <span class="number">0</span>; j &lt; bcinfo-&gt;bc_rt_vars[i].<span class="built_in">size</span>(); j++) &#123;</span><br><span class="line">            <span class="type">size_t</span> var_len = <span class="built_in">type_len</span>(bcinfo-&gt;bc_rt_vars[i][j]);</span><br><span class="line">            <span class="built_in">convert_var_to_buffer</span>(bcinfo-&gt;bc_rt_vars[i][j], offset, (<span class="type">uint8_t</span>*)bcinfo-&gt;bc_sabuf_.data_wds,</span><br><span class="line">                <span class="built_in">I</span>(p_dynamic_Input_).ptr_[pos], var_len);</span><br><span class="line">            offset += var_len;</span><br><span class="line">            pos++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 不能超过缓存大小</span></span><br><span class="line">        <span class="type">int</span> msg_num = bcinfo-&gt;bc_rt_nums[i];</span><br><span class="line">        <span class="keyword">if</span> (offset &lt;= bcinfo-&gt;data_size_) &#123;</span><br><span class="line">            <span class="keyword">if</span> (SUCCESS == <span class="built_in">CORE_BC_Write_Buffer</span>(bcinfo-&gt;dev_num_, bcinfo-&gt;channel_num_, msg_num, <span class="number">0</span>, &amp;bcinfo-&gt;bc_sabuf_)) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// RT-&gt;BC</span></span><br><span class="line">    pos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; bcinfo-&gt;rt_bc_nums.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        <span class="type">int</span> msg_num = bcinfo-&gt;rt_bc_nums[i];</span><br><span class="line">        <span class="keyword">if</span> (SUCCESS == <span class="built_in">CORE_BC_Read_Buffer</span>(bcinfo-&gt;dev_num_, bcinfo-&gt;channel_num_, msg_num, <span class="number">0</span>, &amp;bcinfo-&gt;bc_sabuf_)) &#123;</span><br><span class="line">            <span class="type">size_t</span> offset = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">size_t</span> j = <span class="number">0</span>; j &lt; bcinfo-&gt;rt_bc_vars[i].<span class="built_in">size</span>(); j++) &#123;</span><br><span class="line">                <span class="type">size_t</span> var_len = <span class="built_in">type_len</span>(bcinfo-&gt;rt_bc_vars[i][j]);</span><br><span class="line">                *<span class="built_in">O</span>(p_dynamic_Output_).ptr_[pos] = <span class="built_in">convert_buffer_to_var</span>(bcinfo-&gt;rt_bc_vars[i][j], offset, (<span class="type">uint8_t</span>*)bcinfo-&gt;bc_sabuf_.data_wds);</span><br><span class="line">                offset += var_len;</span><br><span class="line">                pos++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// memset(&amp;bcinfo-&gt;bc_sabuf_, 0, sizeof(bcinfo-&gt;bc_sabuf_)); // 清空上次数据</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**********************************</span></span><br><span class="line"><span class="comment">在此函数中编写自定义积分函数</span></span><br><span class="line"><span class="comment">***********************************/</span></span><br><span class="line"><span class="function"><span class="type">int32_t</span> <span class="title">Block_Port_1553B_BC::integral</span><span class="params">(<span class="type">int32_t</span> msg, <span class="type">double</span> t, <span class="type">double</span>* state, <span class="type">double</span>* derivative)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**********************************</span></span><br><span class="line"><span class="comment">        在此函数中释放内部变量资源</span></span><br><span class="line"><span class="comment">        内部变量：bcinfo_</span></span><br><span class="line"><span class="comment">***********************************/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Block_Port_1553B_BC::destroyInternalVariable</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 是否调用了初始化函数，默认为false（控制引擎会出现直接调用destroy的情况，而成员变量si_未初始化被使用会导致崩溃）</span></span><br><span class="line">    <span class="keyword">if</span> (!binit_) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    CAV1553B_BC_INFO* bcinfo = <span class="built_in">static_cast</span>&lt;CAV1553B_BC_INFO*&gt;(bcinfo_);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> iter = bcinfo-&gt;init_info_1553b_-&gt;<span class="built_in">find</span>(&#123; bcinfo-&gt;dev_num_, bcinfo-&gt;channel_num_ &#125;);</span><br><span class="line">    <span class="keyword">if</span> (iter == bcinfo-&gt;init_info_1553b_-&gt;<span class="built_in">end</span>() || !iter-&gt;second) &#123;</span><br><span class="line">        <span class="built_in">CORE_BC_Stop</span>(bcinfo-&gt;dev_num_, bcinfo-&gt;channel_num_);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span> bcinfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-测试"><a href="#3-测试" class="headerlink" title="3. 测试"></a>3. 测试</h2><p>测试场景包含BC-&gt;RT, RT-&gt;BC, RT-&gt;RT，下面是我们产品一个BC对应的设置界面。</p>
<p><img src="https://cxx001.gitee.io/2023/11/06/project/1553B%E6%9D%BF%E5%8D%A1%E8%AF%A6%E8%A7%A3/image-20231106095256626.png"></p>
<p>这里给BC添加了3条消息，分别是bc-&gt;rt, rt-&gt;bc, rt-&gt;rt。它们是一个数组，一一对应，只有msgType字段少一个是因为rt-&gt;rt这1条消息有2个rt，还有需要注意rtType字段的收&#x2F;发是针对rt来的。</p>
<p>最后，时间匆忙，文章整理得比较粗糙，不过上面的两个示例程序是现场正式环境验证通过了的，封装它们是踩了无数的坑过来的。关于1553B有任何疑问欢迎留言交流~~</p>

    </div>
    
    <div class="post-footer">
        <div>
            
            转载声明：
            商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="" target="_blank">cxx</a>
            
            
        </div>
        <div>
            
        </div>
    </div>
</article>
<div class="article-nav prev-next-wrap clearfix">
    
    
    <a href="/2023/09/21/notes/Effective%20Modern%20C++/" class="next-post btn btn-default" title='《Effective Modern C++》全书内容提炼总结'>
        <span class="hidden-lg">下一篇</span>
        <span class="hidden-xs">
            《Effective Modern C++》全书内容提炼总结</span><i class="fa fa-angle-right fa-fw"></i>
    </a>
    
</div>

<div id="comments">
    
    <script src="https://giscus.app/client.js"
        data-repo="cxx001/myblog-comment"
        data-repo-id="R_kgDOHvvgeg"
        data-category="General"
        data-category-id="DIC_kwDOHvvges4CZehr"
        data-mapping="title"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="light"
        data-lang="zh-CN"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
    </script>

</div>

                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">
            文章目录
        </h3>
        
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-text">简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85"><span class="toc-text">环境安装</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A8%A1%E6%8B%9F%E5%B7%A5%E5%85%B7"><span class="toc-text">模拟工具</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E5%B0%81%E8%A3%85"><span class="toc-text">模块封装</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-RT"><span class="toc-text">1. RT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-BC"><span class="toc-text">2. BC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%B5%8B%E8%AF%95"><span class="toc-text">3. 测试</span></a></li></ol></li></ol>
        
    </div>
</aside>
                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>
<a id="back-to-top" class="icon-btn hide">
    <i class="fa fa-chevron-up"></i>
</a>
    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
    访问量:
    <strong id="busuanzi_value_site_pv">
        <i class="fa fa-spinner fa-spin"></i>
    </strong>
    &nbsp; | &nbsp;
    访客数:
    <strong id="busuanzi_value_site_uv">
        <i class="fa fa-spinner fa-spin"></i>
    </strong>
    
</div>
            </div>
            <div class="col-sm-12">
                <span>Copyright &copy;
                    2022
                    
                </span> |
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> |
                <span>
                    Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a>
                </span>
            </div>
        </div>
    </div>
</div>



<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<script src="/js/app.js?rev=@@hash.js"></script>

</body>
</html>